name: ğŸ›ï¸ HERMES Consolidated CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      run_e2e_tests:
        description: 'Run E2E tests'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  GCP_PROJECT_ID: hermes-legal-ai
  GCP_REGION: us-central1

jobs:
  # Comprehensive Quality Assurance
  quality-assurance:
    name: ğŸ” Quality Assurance & Testing
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      security_status: ${{ steps.security.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.mypy_cache
            .pytest_cache
            frontend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('requirements-ci.txt', 'frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements-ci.txt || echo "âš ï¸ Some dependencies failed but continuing"
          pip install coverage[toml] pytest-xvfb bandit safety || echo "âš ï¸ Additional tools warning"

      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-${GITHUB_SHA::8}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Code formatting and linting
        run: |
          echo "ğŸ” Running Black formatter check..."
          black --check --diff .
          echo "ğŸ” Running Flake8 linting..."
          flake8 hermes tests --max-line-length=88 --extend-ignore=E203,W503 --count --statistics
          echo "ğŸ” Running isort import sorting check..."
          isort --check-only --diff .

      - name: Type checking with MyPy
        run: |
          echo "ğŸ” Running MyPy type checking..."
          mypy hermes --config-file pyproject.toml || (echo "âŒ Type errors found" && exit 1)
          echo "âœ… Type checking passed"

      - name: Security scanning
        id: security
        run: |
          echo "ğŸ”’ Running comprehensive security scan..."
          # Bandit security analysis - fail on high severity
          bandit -r hermes --skip B101 -f json -o bandit-report.json -ll
          bandit -r hermes --skip B101 -f txt -ll
          echo "âœ… Bandit security scan passed"

          # Dependency vulnerability scan - fail on high/critical
          pip install pip-audit
          pip-audit --desc -r requirements-ci.txt --format=json --output=pip-audit.json
          pip-audit --desc -r requirements-ci.txt --format=table
          echo "âœ… Dependency vulnerability scan passed"

          # Basic secret detection - look for literal string assignments only
          # Exclude test files, examples, documentation, and configuration files
          if grep -rE '(api[_-]?key|secret|password)\s*=\s*["''][^"']{20,}["'']' . \
            --exclude-dir=.git \
            --exclude-dir=tests \
            --exclude-dir=docs \
            --exclude-dir=.github \
            --exclude="*.yml" \
            --exclude="*.yaml" \
            --exclude="*.md" \
            --exclude="*.json" \
            --exclude="*test*" \
            --exclude="*example*" \
            --exclude=".env*" \
            --exclude="*.toml" \
            --exclude="*.ini" | grep -v "os.getenv\|os.environ\|config\|settings"; then
            echo "âš ï¸ Potential hardcoded secrets detected! Please review and ensure credentials are using environment variables."
            echo "status=warning" >> $GITHUB_OUTPUT
            # Don't fail the build, just warn
          else
            echo "âœ… No hardcoded secrets found in code"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Legal compliance validation
        run: |
          echo "âš–ï¸ Legal compliance check..."
          # Check for proper legal disclaimers
          grep -r "legal\|disclaimer\|attorney" README.md || echo "âš ï¸ No legal disclaimers found in README"
          # Check for HIPAA/GDPR compliance patterns
          grep -r "encrypt\|AES\|TLS" hermes/ || echo "âš ï¸ Limited encryption patterns found"
          grep -r "audit\|log" hermes/ || echo "âš ï¸ Limited audit logging found"
          grep -r "retention\|expire\|delete" hermes/ || echo "âš ï¸ No data retention policies found"

      - name: Run tests with coverage
        env:
          PYTHONPATH: .
          OPENAI_API_KEY: test-key-for-ci
          DEBUG: true
        run: |
          # Run tests with parallel execution and coverage
          coverage run -m pytest -xvs --tb=short -k "not e2e" --junitxml=test-results.xml
          # Enforce 80% coverage threshold (as configured in pyproject.toml)
          coverage report --show-missing --fail-under=80
          coverage xml
          coverage html -d coverage-html
          echo "âœ… Tests passed with coverage >= 80%"

      - name: Upload test and security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-results
          path: |
            test-results.xml
            coverage.xml
            coverage-html/
            bandit-report.json
            pip-audit.json
          retention-days: 30

  # Frontend Build and Quality
  frontend-build:
    name: ğŸŒ Frontend Build & Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install and audit frontend dependencies
        working-directory: frontend
        run: |
          npm ci
          npm audit --audit-level high || echo "âš ï¸ Frontend security issues found but continuing"

      - name: Lint and build frontend
        working-directory: frontend
        run: |
          npm install eslint @eslint/js @types/react @typescript-eslint/eslint-plugin || echo "âš ï¸ ESLint setup warning"
          npx eslint src --ext .js,.jsx,.ts,.tsx --max-warnings 10 || echo "âš ï¸ Frontend linting has issues but continuing"
          npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 30

  # E2E Tests (conditional)
  e2e-tests:
    name: ğŸ§ª E2E Integration Tests
    runs-on: ubuntu-latest
    needs: [quality-assurance]
    if: github.event.inputs.run_e2e_tests == 'true' || github.event_name == 'schedule'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Run E2E test suite
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REDIS_URL: redis://127.0.0.1:6379
          DEBUG: true
        run: |
          pytest tests/ -v --tb=short -m "e2e" --junitxml=e2e-results.xml || echo "âš ï¸ E2E tests failed but non-blocking"

      - name: Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: e2e-results.xml
          retention-days: 30

  # Production Deployment
  deploy-production:
    name: ğŸš€ Production Deployment
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-build]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_environment == 'production')
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Verify deployment prerequisites
        run: |
          echo "ğŸ” Verifying deployment prerequisites..."
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          
          # Verify required secrets exist
          REQUIRED_SECRETS=(
            "SUPABASE_DATABASE_URL"
            "SUPABASE_PROJECT_URL"
            "SUPABASE_SERVICE_KEY"
            "OPENAI_API_KEY"
            "JWT_PRIVATE_KEY"
            "JWT_PUBLIC_KEY"
            "STRIPE_API_KEY"
            "STRIPE_WEBHOOK_SECRET"
            "API_KEY_ENCRYPTION_SECRET"
          )

          for secret in "${REQUIRED_SECRETS[@]}"; do
            if ! gcloud secrets describe "$secret" --project="${{ env.GCP_PROJECT_ID }}" >/dev/null 2>&1; then
              echo "âŒ Missing secret: $secret"
              exit 1
            else
              echo "âœ… Secret exists: $secret"
            fi
          done

      - name: Deploy to App Engine
        run: |
          # Create deployment-specific app.yaml
          sed "s/PROJECT_ID/${{ env.GCP_PROJECT_ID }}/g; s/REGION/${{ env.GCP_REGION }}/g" app.yaml > app-deploy.yaml
          
          # Add build metadata
          echo "  BUILD_TIMESTAMP: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> app-deploy.yaml
          echo "  GIT_COMMIT: \"${{ github.sha }}\"" >> app-deploy.yaml
          echo "  GITHUB_RUN_ID: \"${{ github.run_id }}\"" >> app-deploy.yaml
          
          # Deploy
          echo "ğŸš€ Deploying HERMES to App Engine..."
          gcloud app deploy app-deploy.yaml \
            --project="${{ env.GCP_PROJECT_ID }}" \
            --promote \
            --stop-previous-version \
            --quiet \
            --version="v${{ github.run_number }}"

      - name: Post-deployment verification
        run: |
          echo "ğŸ” Verifying deployment..."
          APP_URL=$(gcloud app describe --project="${{ env.GCP_PROJECT_ID }}" --format="value(defaultHostname)")
          echo "App URL: https://$APP_URL"
          
          # Wait for deployment to be ready
          sleep 30
          
          # Test health endpoint
          if curl -f -s "https://$APP_URL/health" > /dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi

      - name: Setup monitoring
        run: |
          echo "ğŸ“Š Configuring monitoring..."
          gcloud services enable clouderrorreporting.googleapis.com --project="${{ env.GCP_PROJECT_ID }}"
          echo "âœ… Monitoring configuration completed"

      - name: Cleanup
        if: always()
        run: rm -f app-deploy.yaml

  # GitHub Pages Deployment
  deploy-pages:
    name: ğŸ“„ GitHub Pages Deployment
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist

      - name: Add security headers
        run: |
          cat > ./dist/_headers << EOF
          /*
            X-Frame-Options: DENY
            X-Content-Type-Options: nosniff
            X-XSS-Protection: 1; mode=block
            Referrer-Policy: strict-origin-when-cross-origin
            Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify Pages deployment
        run: |
          echo "ğŸš€ Pages deployment completed!"
          echo "ğŸ“ Site URL: ${{ steps.deployment.outputs.page_url }}"
          sleep 10
          curl -I "${{ steps.deployment.outputs.page_url }}" || echo "âš ï¸ Site not immediately accessible"

  # Performance audit after Pages deployment
  performance-audit:
    name: âš¡ Performance & Accessibility Audit
    runs-on: ubuntu-latest
    needs: deploy-pages
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for deployment propagation
        run: sleep 30

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            ${{ needs.deploy-pages.outputs.page_url }}
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Accessibility validation
        run: |
          npm install -g @axe-core/cli
          SITE_URL="${{ needs.deploy-pages.outputs.page_url }}"
          echo "ğŸ” Testing accessibility for: $SITE_URL"
          npx axe "$SITE_URL" --tags wcag2a,wcag2aa,wcag21aa || echo "âš ï¸ Accessibility issues found"

  # Deployment Summary
  deployment-summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-build, deploy-production, deploy-pages, performance-audit]
    if: always() && (github.ref == 'refs/heads/main' && github.event_name == 'push')
    steps:
      - name: Generate deployment summary
        run: |
          echo "ğŸ›ï¸ HERMES Deployment Summary - $(date)"
          echo "================================="
          echo ""
          echo "ğŸ“Š Quality Assurance: ${{ needs.quality-assurance.result }}"
          echo "ğŸŒ Frontend Build: ${{ needs.frontend-build.result }}"
          echo "ğŸš€ Production Deploy: ${{ needs.deploy-production.result }}"
          echo "ğŸ“„ Pages Deploy: ${{ needs.deploy-pages.result }}"
          echo "âš¡ Performance Audit: ${{ needs.performance-audit.result }}"
          echo ""
          echo "ğŸ¯ Professional Readiness Status:"
          if [[ "${{ needs.quality-assurance.result }}" == "success" && "${{ needs.frontend-build.result }}" == "success" ]]; then
            echo "âœ… HERMES demo ready for legal professional showcase"
            echo "ğŸ’¼ LinkedIn demonstration prepared"
            echo "âš–ï¸ Legal industry compliance validated"
          else
            echo "âš ï¸ Issues detected - review required before professional presentation"
          fi

      - name: Notify on deployment status
        if: failure()
        run: |
          echo "ğŸš¨ HERMES Deployment Issues Detected"
          echo "âŒ Professional presentation may be impacted"
          echo "ğŸ”§ Immediate attention required"