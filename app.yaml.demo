# ====================================================================
# HERMES Demo/Development Deployment Configuration (Google App Engine)
# ====================================================================
# This is a cost-optimized configuration for development and demos.
# Uses minimal resources to reduce costs while maintaining functionality.
#
# Expected Cost: $50-100/month (vs. $300-480/month for production)
#
# Use this for:
# - Initial testing and validation
# - Development environments
# - Proof-of-concept demonstrations
# - Cost-sensitive deployments
#
# For high-performance production, use: app.yaml
#
# Prerequisites:
# 1. Complete setup in DEPLOYMENT_PREREQUISITES.md
# 2. Configure secrets: ./scripts/upload-secrets.sh
# 3. Validate: ./scripts/validate-production.sh --pre-deploy
# 4. Deploy: gcloud app deploy app.yaml.demo
# ====================================================================

runtime: python311
service: default

# Cost-optimized scaling configuration
automatic_scaling:
  min_instances: 1  # Keep at least 1 instance warm (faster response)
  max_instances: 10  # Limit max instances to control costs
  target_cpu_utilization: 0.75  # Higher threshold to reduce scaling
  target_throughput_utilization: 0.80
  cool_down_period_sec: 180  # Longer cooldown to reduce churn
  max_concurrent_requests: 80  # Lower concurrent requests per instance
  max_idle_instances: 2  # Limit idle instances

# Cost-optimized resource allocation
# COST: ~$50-100/month (vs. $300-480 for production config)
resources:
  cpu: 1  # Single CPU (vs. 4 in production)
  memory_gb: 2  # 2GB RAM (vs. 8GB in production)

# Security headers for law firm compliance
env_variables:
  PYTHONPATH: /srv
  # Production mode - no debug/demo features
  DEBUG: "false"
  DEMO_MODE: "false"
  API_HOST: "0.0.0.0"
  API_PORT: "8080"

  # Enterprise security settings
  CORS_ALLOW_ORIGINS: "https://hermes.parallax-ai.app,https://admin.hermes.parallax-ai.app,https://api.hermes.parallax-ai.app"
  JWT_ALGORITHM: "RS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: "15"
  REFRESH_TOKEN_EXPIRE_DAYS: "1"

  # Legal compliance
  CONFIDENCE_THRESHOLD: "0.9"
  ENABLE_DISCLAIMERS: "true"
  AUDIT_LOGGING: "true"

  # Enterprise pricing tier
  STRIPE_TRIAL_DAYS: "0"
  ENTERPRISE_PLAN_PRICE: "2497"
  MAX_MONTHLY_INTERACTIONS: "10000"

  # Secrets Provider Configuration
  # NOTE: Secrets are loaded at runtime via hermes/security/secrets_manager.py
  # Configure secrets in GCP Secret Manager with these names:
  # - SUPABASE_DATABASE_URL
  # - SUPABASE_PROJECT_URL
  # - SUPABASE_SERVICE_KEY
  # - OPENAI_API_KEY
  # - JWT_PRIVATE_KEY
  # - JWT_PUBLIC_KEY
  # - STRIPE_API_KEY
  # - STRIPE_WEBHOOK_SECRET
  # - API_KEY_ENCRYPTION_SECRET
  # See: scripts/upload-secrets.sh for automated setup
  SECRETS_PROVIDER: "gcp"
  GCP_PROJECT_ID: "PROJECT_ID_PLACEHOLDER"  # Replaced by deployment script

# Health check configuration (same as production)
readiness_check:
  path: "/ready"
  check_interval_sec: 5
  timeout_sec: 4
  failure_threshold: 2
  success_threshold: 2

liveness_check:
  path: "/live"
  check_interval_sec: 30
  timeout_sec: 4
  failure_threshold: 4
  success_threshold: 2

# Network security (same as production)
network:
  session_affinity: false

# VPC connector for private Supabase access (optional for demo)
# NOTE: VPC connector adds ~$30/month cost
# For demo environments, you can skip VPC and use public Supabase URLs
# To enable:
# 1. Run: ./scripts/setup-vpc-connector.sh
# 2. Uncomment and update the lines below:
# vpc_access_connector:
#   name: "projects/[YOUR-PROJECT-ID]/locations/[YOUR-REGION]/connectors/hermes-connector"

handlers:
# Static files for dashboard (enterprise clients only)
- url: /static
  static_dir: static
  secure: always
  redirect_http_response_code: 301

# API endpoints with authentication required
- url: /.*
  script: auto
  secure: always
  redirect_http_response_code: 301

# Security headers for HIPAA/SOC2 compliance
includes:
  - security.yaml

# ====================================================================
# Performance Notes for Demo Configuration:
# ====================================================================
# - Response times may be 2-3x slower than production (still usable)
# - Supports ~10-50 concurrent users (vs. 500+ in production)
# - Cold starts may take 5-10 seconds (vs. <2s in production)
# - Good for development, testing, and small-scale demos
#
# Upgrade to production app.yaml when:
# - Deploying for actual law firm clients
# - Need faster response times (<500ms)
# - Expecting >50 concurrent users
# - Running 24/7 production workload
# ====================================================================
