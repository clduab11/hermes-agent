# ===== HERMES Security Enhancements =====
# Additional security configurations for production deployment
# Include this AFTER hermes.conf for enhanced protection

# ===== Admin Endpoints (IP Whitelisting) =====
# Restrict administrative operations to authorized IPs only
# CRITICAL: Update these IPs with your actual admin/office IPs before deployment

geo $admin_allowed {
    default 0;

    # Private networks (Docker, internal services)
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
    127.0.0.1 1;
    ::1 1;

    # TODO: Add your office/admin IPs here
    # Example:
    # 203.0.113.10 1;  # Office IP
    # 198.51.100.0/24 1;  # Admin VPN range
}

# Map for request method restrictions
map $request_method $not_allowed_method {
    default 0;
    TRACE 1;
    TRACK 1;
    DEBUG 1;
}

# ===== Additional Security Rules in HTTPS Server Block =====
# NOTE: These should be added to the main HTTPS server block in hermes.conf

# Admin API Endpoints - Strict IP whitelisting
server {
    listen 443 ssl http2;
    server_name hermes.yourdomain.com;

    # ... (other SSL configuration from hermes.conf)

    # ===== ADMIN ENDPOINTS - IP RESTRICTED =====
    location /api/v1/admin/ {
        # IP whitelisting
        if ($admin_allowed = 0) {
            return 403 "Access denied - unauthorized IP";
        }

        # Strict rate limiting for admin operations
        limit_req zone=auth_limit burst=2 nodelay;
        limit_conn conn_limit 5;

        proxy_pass http://hermes_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Log all admin access
        access_log /var/log/nginx/admin.log main;

        # Shorter timeouts for admin ops
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ===== TENANT MANAGEMENT ENDPOINTS - IP RESTRICTED =====
    location /api/v1/tenants/ {
        # IP whitelisting
        if ($admin_allowed = 0) {
            return 403 "Access denied - unauthorized IP";
        }

        limit_req zone=auth_limit burst=3 nodelay;

        proxy_pass http://hermes_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        access_log /var/log/nginx/admin.log main;
    }

    # ===== SYSTEM MANAGEMENT ENDPOINTS - LOCALHOST ONLY =====
    location /api/v1/system/ {
        # Only accessible from localhost (Docker internal)
        allow 127.0.0.1;
        allow ::1;
        allow 172.16.0.0/12;  # Docker network
        deny all;

        proxy_pass http://hermes_api;
        access_log /var/log/nginx/system.log main;
    }

    # ===== ENHANCED PERFORMANCE MONITORING - PROTECTED =====
    location /api/v1/monitoring/performance {
        # Restrict to admin IPs
        if ($admin_allowed = 0) {
            return 403;
        }

        proxy_pass http://hermes_api;
        proxy_set_header Host $host;
        access_log off;  # Don't log monitoring checks
    }

    # ===== DEAD LETTER QUEUE MANAGEMENT - ADMIN ONLY =====
    location /api/v1/dlq/ {
        # Restrict to admin IPs only
        if ($admin_allowed = 0) {
            return 403 "DLQ access denied - admin only";
        }

        limit_req zone=auth_limit burst=10 nodelay;

        proxy_pass http://hermes_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        access_log /var/log/nginx/dlq.log main;
    }

    # ===== BLOCK MALICIOUS REQUEST METHODS =====
    if ($not_allowed_method) {
        return 405 "Method not allowed";
    }

    # ===== ADDITIONAL SECURITY HEADERS =====
    # These supplement the headers in nginx.conf

    # Prevent clickjacking on admin pages
    add_header X-Frame-Options "DENY" always;

    # Additional CSP for admin pages
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer policy for privacy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions policy (restrict dangerous features)
    add_header Permissions-Policy "geolocation=(), microphone=(self), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
}

# ===== REQUEST SIZE LIMITS =====
# Protect against large request attacks
client_max_body_size 10M;  # Max request body size
client_body_buffer_size 128k;  # Buffer size for client request body
client_header_buffer_size 1k;  # Buffer size for client request headers
large_client_header_buffers 4 8k;  # Large headers protection

# ===== TIMEOUT PROTECTION =====
# Prevent slow HTTP attacks
client_body_timeout 15s;  # Timeout for reading client request body
client_header_timeout 15s;  # Timeout for reading client request headers
send_timeout 30s;  # Timeout for transmitting response

# ===== CONNECTION LIMITS =====
# Limit connections per IP to prevent DoS
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn perip 20;  # Max 20 concurrent connections per IP

# ===== RATE LIMITING ZONES FOR SENSITIVE OPERATIONS =====
# More granular rate limiting for critical operations

# Tenant management operations
limit_req_zone $binary_remote_addr zone=tenant_mgmt_limit:10m rate=5r/m;

# User registration/account creation
limit_req_zone $binary_remote_addr zone=registration_limit:10m rate=3r/h;

# Password reset operations
limit_req_zone $binary_remote_addr zone=password_reset_limit:10m rate=5r/h;

# API key generation/rotation
limit_req_zone $binary_remote_addr zone=api_key_limit:10m rate=2r/h;

# ===== LOGGING CONFIGURATION =====
# Enhanced logging for security monitoring

# JSON log format for security events
log_format security_json escape=json
    '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":"$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"request_time":"$request_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"server_protocol":"$server_protocol"'
    '}';

# Security events log
access_log /var/log/nginx/security.log security_json;

# ===== FAIL2BAN INTEGRATION (OPTIONAL) =====
# If using fail2ban for automated IP blocking, configure:
# 1. Monitor /var/log/nginx/security.log
# 2. Create filter for auth failures (status 401, 403)
# 3. Ban IPs with >10 failures in 10 minutes for 1 hour

# Example fail2ban filter pattern:
# failregex = .*"remote_addr":"<HOST>".*"status":"(401|403)".*
# ignoreregex =
